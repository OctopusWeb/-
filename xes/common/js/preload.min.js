/*所有学科通用js
 * v1.2
 * 2016.10.9
 * 删除根据浏览器尺寸缩放功能。
 * 
 * v1.3
 * 2016.11.28
 * 添加页面元素统计接口
 */

/**解决课件大师字体缓存跨域报错问题*/
if(isElectron()&&isServer()&&false){
    var fontStyle = document.createElement("style");
    fontStyle.innerHTML = '@font-face {font-family: "MicrosoftYaHeiGB";src: url("http://localhost:3001/courseware/font/MicrosoftYaHeiGB.ttf");}}'
    document.head.appendChild(fontStyle);
}

/**是否是electron环境*/
function isElectron(){
    var sUserAgent = navigator.userAgent.toLowerCase();
    return sUserAgent.indexOf("electron")>-1;
}

/**是否是服务器远程运行环境*/
function isServer(){
    return window.location.host!="";
}

/*
 *  pdf转图片模板改名
 *  _name：string 名称
 *  anfeng 2016-9-9
 */
function setTitleName(_name){
 document.getElementsByClassName("header-text")[0].innerText = _name;
 document.title = _name;
}

var xesCommonUtils = (function(){

function xesCommonUtils(){	
	//元素统计接口(需更换)
	var elementURL = "http://tre.ren/test/server/get.php?";
	
	//获取页面地址
	var winLocation = window.location;
	console.log("页面地址:" + winLocation);
	//查询地址栏字符串
	function getQueryString(fieldName)
	{
	    var reg = new RegExp("(^|&)"+ fieldName +"=([^&]*)(&|$)");
	    var r = winLocation.search.substr(1).match(reg);
	    if(r!=null)return  unescape(r[2]); return null;
	}
	
	/**
	 * 统计的字段
	 */
	//分校
	var citycode = getQueryString("citycode");
	//班级ID
	var classid = getQueryString("classid");
	//课程ID
	var curriculum = getQueryString("curriculum");
	//课件ID
	var teachingid = getQueryString("teachingid");
	//教师ID
	var teacherid = getQueryString("teacherid");
	//元素名称
	var elementname = getQueryString("elementname");
	//课件页面
	var pageno = getQueryString("pageno");
	//页面类型
	var pagetype = getQueryString("pagetype");
	if(pagetype == null)
	{
		pagetype = "normal";
	}
	//系统来源
	var sysname = getQueryString("sysname");
	if(sysname == null)
	{
		sysname = "its";
	}
	if(true)
	{
		var info = {};
		info.citycode = citycode;
		info.classid = classid;
		info.curriculum = curriculum;
		info.teachingid = teachingid;
		info.teacherid = teacherid;
		info.pageno = pageno;
		info.pagetype = pagetype;
		info.sysname = sysname;
		console.log("--获取ITS统计信息如下--");
		console.log(info);
	}
	
	//服务器配置跨域文件
	function sendAjax(url, data){
		var XMLHTTP;
		if (window.XMLHttpRequest) { 
			// code for IE7+, Firefox, Chrome, Opera, Safari
		    XMLHTTP = new XMLHttpRequest();
		} else { 
			// code for IE6, IE5
		    XMLHTTP = new ActiveXObject("Microsoft.XMLHTTP");
		}
		
		if(XMLHTTP == null)
		{
			alert("Your browser does not support XMLHTTP."); 
		}
		else
		{
			XMLHTTP.open("GET", url + data, true);
			XMLHTTP.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8");
			XMLHTTP.send();
		}
		console.log("发送统计请求:" + url + data);
		XMLHTTP.onreadystatechange = function(){			
		    if(XMLHTTP.readyState == 4){ 	
		        if(XMLHTTP.status == 200){
		            console.log("统计成功");
		            var response = XMLHTTP.responseText;
		            console.log("返回信息:" + response);
		        }else{
		            console.log("统计失败");
		        }
		    }
		}    
	}
	
	/**
	 * 发送元素统计数据
	 * @param {Object} m_elementName
	 */
	this.sendElementStatisticalData = function(m_elementName){
		var data =  "&citycode=" + citycode +
					"&classid=" + classid +
					"&curriculum=" + curriculum +
					"&teachingid=" + teachingid +
					"&teacherid=" + teacherid +				
					"&elementname=" + m_elementName +
					"&pageno=" + pageno +
					"&pagetype=" + pagetype +
					"&sysname=" + sysname;
//		sendAjax(elementURL, data);
		
//		jqueryAJAX(elementURL, data);
	}  
	  
	//
	function jqueryAJAX(serverURL, sendData){
		$.ajax({
             type: "get",
             async: true,
             url: serverURL,
			 data: sendData,
			 contentType: "application/x-www-form-urlencoded; charset=utf-8", 
             success: function(response, status, xhr){
             	console.log("服务端返回:" + response);
             },
             error: function(){
                 console.log('fail');
             }
        });	
	}
}

return xesCommonUtils;
})();

//初始化
var xesUtils = new xesCommonUtils();